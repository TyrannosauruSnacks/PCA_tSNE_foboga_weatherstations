---
title: "tSNE"
author: "Max Hachemeister"
date: "2025-03-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
library(tidyverse)
library(tidymodels)
library(Rtsne)
```

## 1. t-SNE plot with the iris dataset

### 1.1 Let's check the original examples

```{r}
## remove duplicates
iris_unique <- unique(iris)

## select variable columns into new object
iris_matrix <- as.matrix(iris_unique[,1:4])

## set seed
set.seed(42)

## calculate tsne values
tsne_foboga_results <- Rtsne(iris_matrix,
                      pca = FALSE,
                      perplexity = 30,
                      theta = 0.0)

## plot foboga_results
plot(
  # take x and Y values from the  tsne_foboga_results list Y data
  tsne_foboga_results$Y,
  # color those points by species from original dataframe
  col = iris_unique$Species,
  # make it a square plot
  asp = 1)
```

### 1.2 Let's try `ggplot`

#### 1.2.1 So it does not run right away
"`tsne_foboga_results` is not a dataframe and cant be coerced by `fortify`."
```{r}
tsne_foboga_results |> 
  ggplot(aes(x = Y, y = Y, colour = iris_unique$Species)) +
  geom_point()
```

#### 1.2.2 What does `fortify()` do?
```{r}
fortify(tsne_foboga_results)
```

#### 1.2.3 cant be coerced `as.data.frame()` either

```{r}
as.data.frame(tsne_foboga_results)
```
#### 1.2.4 A `list` seems to be something special within R.
Parts of the list can be used as a dataframe, by adressing these with `$`

```{r}
as.data.frame(tsne_foboga_results$Y)
```

#### 1.2.5 Good, so try this with `ggplot()`
```{r}
ggplot(
  as.data.frame(tsne_foboga_results$Y),
  aes(x = V1, y = V2, color = iris_unique$Species)
  ) +
  geom_point()
```

#### 1.2.6 Clean code a bit
```{r}
as.data.frame(tsne_foboga_results$Y) |> 
  ggplot(aes(V1, V2, color = iris_unique$Species)) +
  geom_point()
```

## 2 Foboga data

### 2.1 Basic EDA

#### 2.1.1 Scatterplot and Stats
```{r}
foboga |>
  mutate(Station = as.factor(Station)) |> 
  ggplot(aes(`Humidity (2m)`, `Soil moisture (-0.25m)`)) +
  geom_point(aes(colour = Station, alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

foboga |> 
  group_by(Station) |> 
  summarise(n = n(),
            mean_humidity2m = mean(`Humidity (2m)`),
            mean_soil_moisture = mean(`Soil moisture (-0.25m)`))
```
### 2.2 Tidy  data

#### 2.2.1 Convert `Timestamp` and `Station`
Time comes as `chr` data and is more useful as `num`.
Station is `num` and is more useful as `factor`.
```{r}
foboga_tidy <- foboga |>
    mutate(Timestamp = ymd_hms(Timestamp),
           Station = as.factor(Station)
           )
```

#### 2.2.1 Humidity-Curve over time per Station
```{r}
foboga_tidy |> 
  ggplot(aes(Timestamp, `Humidity (2m)`, color = Station)) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_brewer(palette = "Set1")
```

### 2.3 What does Rtsne do?

#### 2.3.1 Select and Filter
Rtsne wants only unique/distinc rows and I also want the `Station` column to not be considered as this is the category for later exploration.

```{r}
foboga_data <- foboga_tidy |>
  distinct() |>
  # select all columns from Timestamp till Soil moisture
  select(`Timestamp` : `Soil moisture (-0.55m)`)

foboga_station <- foboga_tidy |> 
  distinct() |> 
  select(Station)
```

#### 2.3.2 Calculate Rtsne data
```{r}
## set seed for later reproduction
set.seed(42)

## calculate and safe Rtsne data
foboga_Rtsne_perp1000_the50 <- Rtsne(foboga_data,
                      perplexity = 1000,
                      theta = 0.5,
                      check_duplicates = FALSE,
                      num_threads = 0)
```

#### 2.3.3 Plot
```{r}
## Perplexity 50
as.data.frame(foboga_Rtsne_perp50_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 100
as.data.frame(foboga_Rtsne_perp100_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 200
as.data.frame(foboga_Rtsne_perp200_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 1000
as.data.frame(foboga_Rtsne_perp1000_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")
```
#### 2.3.4 Select some more
So with the `Timestamp` we can only see, that there are different clusters over time.
So the timestamp explains the most variabiliy. Loose it and see better how the other variables interact.
```{r}
foboga_select <- foboga_data |> 
  select(`Temperature (2m)` : `Soil moisture (-0.55m)`)

```
#### 2.3.5 Calculate some more
```{r}
## set seed for later reproduction
set.seed(42)

## calculate and safe Rtsne data
foboga_select_Rtsne_perp1000_the50 <- Rtsne(foboga_select,
                      perplexity = 1000,
                      theta = 0.5,
                      check_duplicates = FALSE,
                      num_threads = 0)
```

#### 2.3.6 Plot some more
```{r}
## Perplexity 50
as.data.frame(foboga_select_Rtsne_perp50_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 100
as.data.frame(foboga_select_Rtsne_perp100_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 200
as.data.frame(foboga_select_Rtsne_perp200_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")

## Perplexity 1000
as.data.frame(foboga_select_Rtsne_perp1000_the50$Y) |> 
  ggplot(aes(V1, V2, color = as.factor(foboga_station$Station)))+
  geom_point(aes(alpha = 0.25)) +
  scale_color_brewer(palette = "Set1")
```

### 2.4 PCA

#### 2.4.1 Calculate Principal Components
```{r}
# calculate principal components
foboga_results <- prcomp(foboga_select, scale. = TRUE)

# reverse the signs
## don't know why
foboga_results$rotation <- -1*foboga_results$rotation

# display principal components
foboga_results$rotation

```

#### 2.4.2 Scores

```{r}
# reverse the signs of the scores
## still dont know why
foboga_results$x <- -1*foboga_results$x

# check scores
head(foboga_results$x)
```

#### 2.4.3 Plot
[Biplot with GGplot](https://www.geeksforgeeks.org/how-to-create-a-biplot-in-r/)

```{r}
# ggfortify can handle PCA-Data
library(ggfortify)

autoplot(foboga_results,
         data = foboga_select,
         color = (foboga_station$Station),
         loadings = TRUE,
         loadings.label = TRUE,
         loadings.label.size = 3,
         alpha = 0.25) +
  scale_color_brewer(palette = "Set1")
```
